<div class="fiction-details bg-white dark:bg-gray-900 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
  <!-- Main Content Section (2/3 of the partial) -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
    <!-- Left Column - Main Content (2/3) -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Book Header Section -->
      <div class="flex flex-col sm:flex-row gap-4 items-start justify-center lg:justify-start">
        <!-- Book Cover Image -->
        <div class="flex-shrink-0 border border-stone-200 dark:border-gray-700 mx-auto lg:mx-0 relative">
          <%= image_tag url_for(fiction.cover),
                      class: 'w-32 h-48 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 shadow-md flex items-center justify-center',
                      alt: fiction.cover.blob.filename %>
        </div>
        <!-- Book Info -->
        <div class="mx-auto lg:mx-0 mt-1">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 text-center lg:text-left line-clamp-1"><%= fiction.title %></h1>
          <div class="text-sm text-gray-600 dark:text-gray-300 text-center lg:text-left">
            <p><span class="font-medium italic line-clamp-1"><%= fiction.alternative_title %></span></p>
            <p><span class="font-medium italic line-clamp-1"><%= fiction.english_title %></span></p>
            <div class="mt-4 flex items-center gap-2 justify-center lg:justify-start">
              <span class="font-bold">Автор:</span>
              <%= button_to fiction.author, search_index_path, method: :get, id: 'fictions-author-search',
                class: 'inline-block bg-stone-200 dark:bg-gray-700 hover:bg-stone-300 dark:hover:bg-gray-600 text-stone-700 dark:text-gray-300 px-2 sm:px-3 py-1 rounded-full text-xs transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105',
                params: { search: [fiction.author] },
                form: { class: 'inline' } %>
            </div>
            <div class="mt-4 flex items-center gap-2 justify-center lg:justify-start">
              <span class="font-bold">Перекладач:</span>
              <% fiction.scanlators.each do |scanlator| %>
                <%= link_to fiction.scanlators.size > 1 ? scanlator.title.first(10) : scanlator.title.first(20), scanlator_path(scanlator),
                    class: 'bg-stone-200 dark:bg-gray-700 hover:bg-stone-300 dark:hover:bg-gray-600 text-stone-700 dark:text-gray-300 px-2 sm:px-3 py-1 rounded-full text-xs transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105' %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      <!-- Stats Section (2/3 of the partial) -->
      <div class="">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="text-center bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-stone-800 dark:text-white"><%= fiction.total_chapters %></div>
            <div class="text-sm text-stone-600 dark:text-gray-400">Розділи</div>
          </div>
          <div class="text-center bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-stone-800 dark:text-white"><%= format_view_count(fiction.views) %></div>
            <div class="text-sm text-stone-600 dark:text-gray-400">Перегляди</div>
          </div>
          <div class="text-center bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-stone-800 dark:text-white">
              <% status_text = Fiction.statuses[fiction.status].to_s %>
              <%= status_text.length > 6 ? "#{status_text[0..5]}." : status_text %>
            </div>
            <div class="text-sm text-stone-600 dark:text-gray-400">Статус</div>
          </div>
          <div class="text-center bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-stone-800 dark:text-white"><%= fiction.readings.count %></div>
            <div class="text-sm text-stone-600 dark:text-gray-400">Закладинки</div>
          </div>
        </div>
      </div>

      <!-- Genres -->
      <% if fiction.genres.any? %>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Жанри</h4>
          <div class="flex flex-wrap gap-2">
            <% fiction.genres.each do |genre| %>
              <%= tag.span genre.name, class: 'bg-stone-200 dark:bg-gray-700 text-stone-700 dark:text-gray-300 px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm hover:bg-stone-300 dark:hover:bg-gray-600 transition duration-300' %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Description Section (2/3 of the partial) -->
      <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
        <h3 class="font-semibold text-gray-900 dark:text-white">Опис</h3>
        <div class="text-sm sm:text-base text-stone-600 dark:text-gray-400 whitespace-pre-line leading-relaxed">
          <%= fiction.description %>
        </div>
      </div>

      <div class="-mb-4">
        <%= render 'fictions/support', fiction: fiction if fiction.scanlators.pluck(:bank_url).compact_blank.any? %>
      </div>
    </div>
    <!-- Right Column - Sidebar (1/3) -->
    <div class="space-y-6">
      <!-- Start Reading Button -->
      <%= link_to ordered_chapters(fiction).first, class: 'w-full bg-white dark:bg-gray-800 text-stone-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg border border-stone-200 dark:border-gray-700 shadow-sm hover:bg-stone-100 dark:hover:bg-gray-700 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 flex items-center justify-center space-x-2' do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
        </svg>
        <span>Читати</span>
      <% end %>
      <!-- Status Change Section -->
      <% if user_signed_in? %>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg">
          <%= turbo_frame_tag 'fiction-reading-status' do %>
            <div class="sm:hidden lg:block">
              <%= render 'fictions/reading_status_controls', fiction: fiction, show_presenter: show_presenter %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Monthly Views Stats -->
      <% hot_updates = FictionIndexVariablesManager.hot_updates.count %>
      <% current_reads = hot_updates[fiction.id] || 0 %>
      <% total_fictions = hot_updates.keys.count %>

      <% if total_fictions.nonzero? %>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
          <h4 class="text-xl font-bold text-stone-800 dark:text-gray-200 mb-4">Славомір</h4>
          <% current_rank = hot_updates.values.sort.reverse.index(current_reads)&.+(1) || total_fictions %>

          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-stone-600 dark:text-gray-400">Щабель цього місяця:</span>
            <span class="text-2xl font-extrabold text-stone-800 dark:text-gray-200 bg-stone-100 dark:bg-gray-700 px-3 py-1 rounded-lg">#<%= current_rank %></span>
          </div>
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-stone-600 dark:text-gray-400">Прочитань цього місяця:</span>
            <span class="text-xl font-bold text-stone-800 dark:text-gray-200"><%= current_reads %></span>
          </div>
          <div class="w-full bg-stone-200 dark:bg-gray-600 rounded-full h-3 overflow-hidden">
            <div class="bg-stone-600 dark:bg-gray-200 h-full rounded-full transition-all duration-500 ease-out"
                  style="width: <%= [100 - (current_rank.to_f / total_fictions * 100), 100].min %>%"></div>
          </div>
          <p class="text-xs font-medium text-stone-500 dark:text-gray-400 mt-2 text-right">
            Перші <%= ((current_rank.to_f / total_fictions) * 100).round(1) %>% цього місяця
          </p>
        </div>
      <% end %>

      <!-- You May Also Like -->
      <% if show_presenter.related_fictions.any? %>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Також може сподобатися</h3>
          <div class="space-y-3">
            <% show_presenter.related_fictions.each do |similar_fiction| %>
              <div class="flex items-center gap-3">
                <%= link_to fiction_path(similar_fiction), class: '' do %>
                  <%= image_tag url_for(similar_fiction.cover), class: 'object-cover w-12 h-16 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded flex items-center justify-center text-lg' %>
                <% end %>
                <div class="flex-1 min-w-0">
                  <%= link_to similar_fiction.title, fiction_path(similar_fiction), class: 'font-medium text-sm text-gray-900 dark:text-white truncate line-clamp-1' %>
                  <div class="text-xs text-gray-600 dark:text-gray-300"><%= similar_fiction.genres.sample(2).map(&:name).join(', ') %></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Bookmarks Stats -->
      <div class="">
        <div class="grid grid-cols-2 gap-3 text-center">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-lg font-bold text-blue-600 dark:text-blue-400"><%= show_presenter.bookmark_stats[0] %></div>
            <div class="text-xs text-gray-600 dark:text-gray-300">Читають</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-lg font-bold text-green-600 dark:text-green-400"><%= show_presenter.bookmark_stats[1] %></div>
            <div class="text-xs text-gray-600 dark:text-gray-300">Прочитано</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-lg font-bold text-yellow-600 dark:text-yellow-400"><%= show_presenter.bookmark_stats[2] %></div>
            <div class="text-xs text-gray-600 dark:text-gray-300">Відкладено</div>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
            <div class="text-lg font-bold text-red-600 dark:text-red-400"><%= show_presenter.bookmark_stats[3] %></div>
            <div class="text-xs text-gray-600 dark:text-gray-300">Покинуто</div>
          </div>
        </div>
      </div>

      <!-- Badges and Awards -->
      <% if show_presenter.ranks.any? %>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-stone-200 dark:border-gray-700">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Відзнаки та нагороди</h3>
          <!-- Creative Badge Layout -->
          <div class="relative">
            <!-- Main Badge - Largest -->
            <% main_rank = show_presenter.ranks.first %>
            <% if main_rank && Rails.application.assets_manifest.assets["badges/#{FictionsHelper::GENRE_BADGES[main_rank[0]]}.webp"].present? %>
              <div class="text-center mb-4">
                <div class="relative inline-block">
                  <%= image_tag asset_path("badges/#{FictionsHelper::GENRE_BADGES[main_rank[0]]}.webp"),
                                alt: "badge-#{FictionsHelper::GENRE_BADGES[main_rank[0]]}",
                                class: "h-24 w-24 rounded-full object-cover shadow-lg ring-4 ring-yellow-400 dark:ring-yellow-500 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105" %>
                  <div class="absolute -top-2 -right-2 bg-red-500 text-white text-lg font-bold w-8 h-8 rounded-full flex items-center justify-center shadow-lg">
                    #<%= main_rank[1] %>
                  </div>
                </div>
                <div class="mt-3 text-sm font-bold text-gray-900 dark:text-white">
                  <%= main_rank[0].to_s.titleize %>
                </div>
              </div>
            <% end %>

            <% if show_presenter.ranks.to_a[1..3].any? %>
              <div class="flex justify-center space-x-3">
                <% show_presenter.ranks.to_a[1..3].each do |rank_data| %>
                  <% rank, value = rank_data %>
                  <% if Rails.application.assets_manifest.assets["badges/#{FictionsHelper::GENRE_BADGES[rank]}.webp"].present? %>
                    <div class="text-center">
                      <div class="relative">
                        <%= image_tag asset_path("badges/#{FictionsHelper::GENRE_BADGES[rank]}.webp"),
                                      alt: "badge-#{FictionsHelper::GENRE_BADGES[rank]}",
                                      class: "h-12 w-12 rounded-full object-cover shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105" %>
                        <div class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
                          #<%= value %>
                        </div>
                      </div>
                      <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 font-medium">
                        <%= rank.to_s.titleize.length > 5 ? "#{rank.to_s.titleize[0..4]}..." : rank.to_s.titleize %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
